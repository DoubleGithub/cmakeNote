# 0 序言
经过6篇的入门（tutorial）介绍，总算开始系统地对cmake进行介绍了。

文章内容部分翻译自cmake的官方文档。但是，为了让大家和自己都有更好的理解，我将用更加简单的方式，一步一步来探索，力求展现出cmake的强大、简单和实用。

# 1 简介
cmake构建系统由高度抽象的逻辑概念——目标（targets）组成。目标可以是可执行文件(executable)、库(library)、或者包含自定义指令的用户目标——使用add_custom_command添加的命令。

所有targets之间的依赖关系，决定了他们的生成顺序，以及当target依赖的文件发生改变时，如何重新生成该target。

# 2 binary-target
binary-target包括可执行文件和库文件。使用指令"add_executable()"生成可执行文件，"add_library()"生成库文件。

依据不同平台，生成的binary-target前后会加上前缀(prefix)、后缀(suffix)、以及扩展名(extension)。

binary-target之间，通过指令"target_link_libraries()"进行链接。如下面的指令。生成的库文件"archive"依赖于多个源文件，可执行文件"zipapp"依赖于源文件"zipapp.cpp"和静态库文件"archive"。

```
add_library (archive zip.cpp app.cpp archive.cpp)
add_executable (zipapp zipapp.cpp)
target_link_libraries (zipapp archive)
```

## 1 可执行文件(binary executable)
下面语句定义了一个可执行目标。其中，构建系统保证"add_custom_command()"在调用可执行文件时，可执行文件已经生成好。

```
add_custom_command (OUTPUT ${PROJECT_BINARY_DIR}/myTable.h
  COMMAND makeTable ${PROJECT_BINARY_DIR}/myTable.h
  DEPENDS makeTable
  )

add_executable(main main.cpp myTable.h) # 保证myTable.h已经生成
```

## 2 库类型(binary library types)
#### 1 普通库 (normal library)
指令"add_library()"默认生成静态库(static library)，若希望编译其他类型的库，则需要显式给出库的类型。如下面指令。

```
add_library(archive SHARED archive.cpp zip.cpp app.cpp)
add_library(archive STATIC archive.cpp)
```

指定变量"BUILD_SHARED_LIBS"可以让"add_library()"默认生成共享库(即动态库)。在构建系统中，通常库的类型并不影响命令、依赖关系以及程序API的调用。

只有在库类型为MODULE时才需要注意。MODULE类型库不能用"target_link_libraries()"指令来链接，其作为插件(plugin)，在运行时(runtime)期间使用。

```
add_library(archive MODUEL 7z.cpp)
```

#### 2 apple framework
通过对共享库标记FRAMEWORK，可以构建macOS或者IOS framework bundle。MACOSX_FRAMEWORK_IDENTIFIERS设置了唯一的CFBundleIdentifier key。

```
add_library (MyFramework SHARED MyFramework.cpp)
set_target_properties (MyFramework PROPERTIES
  FRAMEWORK TRUE
  FRAMEWORK_VERSION A
  MACOSX_FRAMEWORK_IDENTIFIER org.cmake.MyFramework)
```


#### 3 对象库 (object library)
OJBECT库类型也不用于链接。源文件经过编译后，生成OBJECT库作为中间输入文件，用于生成其他的目标文件。如下面所示。

```
add_library (archive OBJECT archive.cpp zip.cpp app.cpp)
add_library(archiveExtras STATIC $<TARGET_OBJECTS:archive> extras.cpp) # 利用OBJECT生成静态库文件
add_executable(test $<TARGET_OBJECTS:archive> test.cpp) # 利用OBJECT库生成可执行文件
```

OBJECT库文件只能用作输入文件——不能installed, exported, 也不能用于"target_link_libraries()"。也不能在"add_custom_command(TARGET)"命令中作为TARGET使用。

尽管OBJECT库无法在target_link_libraries()中链接，但是，可通过"Interface Library"中的内置变量来间接链接。"Interface Library"中的"INTERFACE_SOURCES"目标属性值被设置为$<TARGET_OBJECTS:objlib>。
